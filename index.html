<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>SAPP ‚Äì Soziale Arbeit Protokoll & Planung</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@400;600;700;900&display=swap');
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg:#121212; --bg2:#1e1e1e;
    --green:#388E3C; --green-dark:#2E7D32;
    --blue:#2196F3; --blue-dark:#1976D2;
    --red:#D32F2F; --red-dark:#C62828;
    --red-mic:#ff1744; --red-mic-dk:#d50000;
    --orange:#FF9800; --orange-dark:#F57C00;
    --slate:#607D8B; --slate-dark:#455A64; --slate-darker:#37474F;
    --text:#ffffff; --text-dim:#666666; --radius:10px;
  }
  html,body { width:100%; height:100%; background:var(--bg); color:var(--text); font-family:'Barlow',sans-serif; overflow:hidden; display:flex; flex-direction:column; }
  #app { display:flex; flex-direction:column; width:100%; height:100%; }

  #layHeader { flex:0 0 12%; display:flex; align-items:center; justify-content:center; padding:2% 5% 1%; }
  #btnSelectKlient { width:90%; height:70%; background:linear-gradient(180deg,var(--green),var(--green-dark)); color:#fff; border:none; border-radius:var(--radius); font-family:'Barlow',sans-serif; font-size:clamp(14px,4vw,22px); font-weight:700; cursor:pointer; letter-spacing:.05em; transition:filter .15s; text-overflow:ellipsis; overflow:hidden; white-space:nowrap; padding:0 12px; }
  #btnSelectKlient:active { filter:brightness(.85); }

  #layWork { flex:0 0 73%; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:1%; gap:8px; overflow:hidden; }
  #txtLogo { font-family:'Barlow',sans-serif; font-size:clamp(24px,7vw,35px); font-weight:900; color:var(--blue); letter-spacing:.15em; user-select:none; }

  #btnMic { width:min(45vw,140px); aspect-ratio:1; max-height:20vh; background:radial-gradient(circle at 35% 35%,var(--blue),var(--blue-dark)); border:2px solid var(--blue); border-radius:50%; color:#fff; font-size:clamp(36px,12vw,60px); cursor:pointer; transition:background .3s,border-color .3s,box-shadow .3s; display:flex; align-items:center; justify-content:center; box-shadow:0 0 0 0 rgba(33,150,243,0); user-select:none; flex-shrink:0; }
  #btnMic.listening { background:radial-gradient(circle at 35% 35%,var(--red-mic),var(--red-mic-dk)); border-color:var(--red-mic); animation:pulse-mic 1.2s infinite; }
  #btnMic:active { filter:brightness(.85); }
  @keyframes pulse-mic { 0%{box-shadow:0 0 0 0 rgba(255,23,68,.5)} 70%{box-shadow:0 0 0 18px rgba(255,23,68,0)} 100%{box-shadow:0 0 0 0 rgba(255,23,68,0)} }

  #txtStatus { font-family:'Share Tech Mono',monospace; font-size:clamp(11px,3vw,15px); color:var(--text-dim); letter-spacing:.1em; user-select:none; transition:color .3s; }
  #txtStatus.active { color:var(--red-mic); }

  #txtLiveTranskript { width:90%; flex:1; min-height:0; background:var(--bg2); color:#fff; font-family:'Barlow',sans-serif; font-size:clamp(13px,3.5vw,15px); border:1px solid #333; border-radius:var(--radius); padding:10px 12px; resize:none; outline:none; line-height:1.5; }
  #txtLiveTranskript:focus { border-color:#555; }

  #layBtns { width:90%; display:flex; flex-direction:row; gap:2%; flex-shrink:0; height:6vh; min-height:36px; }
  .btn-action { flex:1; border:none; border-radius:var(--radius); font-family:'Barlow',sans-serif; font-weight:700; font-size:clamp(11px,3vw,14px); color:#fff; cursor:pointer; transition:filter .15s; letter-spacing:.03em; }
  .btn-action:active { filter:brightness(.8); }
  #btnClean { background:linear-gradient(180deg,var(--slate),var(--slate-dark)); }
  #btnUndo  { background:linear-gradient(180deg,var(--slate-dark),var(--slate-darker)); }

  #layBottom { flex:0 0 10%; display:flex; flex-direction:row; align-items:center; justify-content:center; gap:2%; padding:0 5%; }
  .btn-bottom { flex:1; height:70%; border:none; border-radius:var(--radius); font-family:'Barlow',sans-serif; font-weight:700; font-size:clamp(10px,2.8vw,13px); color:#fff; cursor:pointer; transition:filter .15s; letter-spacing:.02em; }
  .btn-bottom:active { filter:brightness(.8); }
  #btnPlus   { background:linear-gradient(180deg,var(--green),var(--green-dark)); }
  #btnExport { background:linear-gradient(180deg,var(--orange),var(--orange-dark)); }
  #btnMinus  { background:linear-gradient(180deg,var(--red),var(--red-dark)); }

  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:1000; align-items:center; justify-content:center; }
  .modal-overlay.visible { display:flex; }
  .modal-box { background:#1a1a1a; border:1px solid #333; border-radius:14px; width:min(85vw,400px); padding:20px 16px 16px; display:flex; flex-direction:column; gap:12px; animation:modal-in .2s ease; }
  @keyframes modal-in { from{transform:scale(.88);opacity:0} to{transform:scale(1);opacity:1} }
  .modal-title { font-family:'Share Tech Mono',monospace; font-size:18px; color:var(--blue); letter-spacing:.1em; border-bottom:1px solid #333; padding-bottom:8px; }
  .modal-label { font-size:14px; color:#aaa; margin-bottom:2px; }
  .modal-select { width:100%; background:var(--bg2); color:#fff; border:1px solid #444; border-radius:8px; padding:8px 10px; font-family:'Barlow',sans-serif; font-size:15px; outline:none; cursor:pointer; }
  .modal-select:focus { border-color:var(--blue); }
  .modal-input { width:100%; background:var(--bg2); color:#fff; border:1px solid #444; border-radius:8px; padding:10px 12px; font-family:'Barlow',sans-serif; font-size:15px; outline:none; }
  .modal-input:focus { border-color:var(--blue); }
  .modal-btn-row { display:flex; gap:8px; }
  .modal-btn { flex:1; padding:10px 8px; border:none; border-radius:8px; font-family:'Barlow',sans-serif; font-weight:700; font-size:14px; color:#fff; cursor:pointer; transition:filter .15s; letter-spacing:.03em; }
  .modal-btn:active { filter:brightness(.8); }
  .modal-btn.primary { background:var(--blue); }
  .modal-btn.danger  { background:var(--red); }
  .modal-btn.cancel  { background:var(--slate-dark); }
  .modal-btn.full    { flex:none; width:100%; background:var(--blue); }

  #klientenListe { max-height:45vh; overflow-y:auto; display:flex; flex-direction:column; gap:4px; }
  .klienten-item { background:var(--bg2); border:1px solid #333; border-radius:8px; padding:12px 14px; font-size:16px; cursor:pointer; transition:background .15s,border-color .15s; font-weight:600; }
  .klienten-item:hover,.klienten-item:active { background:#2a2a2a; border-color:var(--blue); }
  .warn-text { color:#ff0000; font-size:14px; line-height:1.5; }

  #toast { position:fixed; bottom:15%; left:50%; transform:translateX(-50%) translateY(10px); background:rgba(50,50,50,.95); color:#fff; padding:10px 20px; border-radius:20px; font-size:14px; font-family:'Barlow',sans-serif; font-weight:600; pointer-events:none; opacity:0; transition:opacity .25s,transform .25s; z-index:2000; white-space:nowrap; }
  #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
  #noSpeechWarn { display:none; position:fixed; top:0; left:0; right:0; background:#b71c1c; color:#fff; text-align:center; padding:6px 10px; font-size:12px; z-index:999; }
  ::-webkit-scrollbar { width:4px; }
  ::-webkit-scrollbar-track { background:#1a1a1a; }
  ::-webkit-scrollbar-thumb { background:#444; border-radius:4px; }
</style>
</head>
<body>

<div id="noSpeechWarn">‚ö†Ô∏è Dein Browser unterst√ºtzt keine Spracherkennung. Bitte Chrome verwenden.</div>

<div id="app">
  <div id="layHeader">
    <button id="btnSelectKlient">KLIENT W√ÑHLEN</button>
  </div>
  <div id="layWork">
    <div id="txtLogo">SAPP</div>
    <button id="btnMic">üé§</button>
    <div id="txtStatus">BEREIT</div>
    <textarea id="txtLiveTranskript" placeholder="Protokoll erscheint hier..."></textarea>
    <div id="layBtns">
      <button class="btn-action" id="btnClean">ü™Ñ POLIEREN</button>
      <button class="btn-action" id="btnUndo">‚Ü© UNDO</button>
    </div>
  </div>
  <div id="layBottom">
    <button class="btn-bottom" id="btnPlus">‚ûï NEU</button>
    <button class="btn-bottom" id="btnExport">üì§ TEILEN</button>
    <button class="btn-bottom" id="btnMinus">üóëÔ∏è L√ñSCHEN</button>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="dlgKlienten">
  <div class="modal-box">
    <div class="modal-title">KLIENTEN</div>
    <div id="klientenListe"></div>
    <button class="modal-btn cancel" onclick="closeDlg('dlgKlienten')">SCHLIESSEN</button>
  </div>
</div>

<div class="modal-overlay" id="dlgNeu">
  <div class="modal-box">
    <div class="modal-title">NEU</div>
    <input class="modal-input" id="inputNeuKlient" type="text" placeholder="Klientenname eingeben...">
    <div class="modal-btn-row">
      <button class="modal-btn primary" id="btnNeuOK">OK</button>
      <button class="modal-btn cancel" onclick="closeDlg('dlgNeu')">ABBRECHEN</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="dlgSpeichern">
  <div class="modal-box">
    <div class="modal-title">DETAILS</div>
    <div class="modal-label">Ma√ünahme:</div>
    <select class="modal-select" id="spinArt">
      <option>Aufsuchend</option>
      <option>Begleitend</option>
      <option>B√ºro</option>
    </select>
    <div class="modal-label">Dauer:</div>
    <select class="modal-select" id="spinDauer">
      <option>0.5</option><option>1.0</option><option>1.5</option><option>2.0</option>
      <option>2.5</option><option>3.0</option><option>3.5</option><option>4.0</option>
    </select>
    <button class="modal-btn full" id="btnSpeichernOK">SPEICHERN</button>
  </div>
</div>

<div class="modal-overlay" id="dlgLoeschen">
  <div class="modal-box">
    <div class="modal-title">L√ñSCHEN BEST√ÑTIGEN</div>
    <p class="warn-text" id="txtWarnLoeschen"></p>
    <div class="modal-btn-row">
      <button class="modal-btn danger" id="btnJaLoeschen">JA, ALLES L√ñSCHEN</button>
      <button class="modal-btn cancel" onclick="closeDlg('dlgLoeschen')">ABBRECHEN</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
var speech, isListening=false, isBusy=false, sessionText="";
var gewaehlterKlient="KLIENT W√ÑHLEN", letzterText="", klientenArray=[];
var FILE_PREFIX="SAPP_FILE_";

var btnSelectKlient=document.getElementById("btnSelectKlient");
var btnMic=document.getElementById("btnMic");
var txtStatus=document.getElementById("txtStatus");
var txtLiveTranskript=document.getElementById("txtLiveTranskript");

function fileExists(p){return localStorage.getItem(FILE_PREFIX+p)!==null;}
function readFile(p){return localStorage.getItem(FILE_PREFIX+p)||"";}
function writeFile(p,c){localStorage.setItem(FILE_PREFIX+p,c);}
function deleteFile(p){localStorage.removeItem(FILE_PREFIX+p);}
function loadText(k,fb){var v=localStorage.getItem(k);return v!==null?v:fb;}
function saveText(k,v){localStorage.setItem(k,v);}

function InitSpeech(){
  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){document.getElementById("noSpeechWarn").style.display="block";return;}
  speech=new SR();
  speech.lang="de-DE"; speech.interimResults=false; speech.maxAlternatives=1; speech.continuous=false;
  speech.onstart=function(){btnMic.classList.add("listening");txtStatus.textContent="SAPP H√ñRT ZU...";txtStatus.classList.add("active");isBusy=false;};
  speech.onresult=function(e){SpracheErkannt([e.results[e.results.length-1][0].transcript]);};
  speech.onerror=function(e){if(e.error==="no-speech"&&isListening)setTimeout(function(){if(isListening)speech.start();},200);};
  speech.onend=function(){if(isListening)setTimeout(function(){if(isListening)speech.start();},200);};
}

function OnStart(){LadeSAPPListen();InitSpeech();EventListeners();}

function EventListeners(){
  btnSelectKlient.addEventListener("click",KlientWaehlen);
  btnMic.addEventListener("click",SprechenToggle);
  document.getElementById("btnClean").addEventListener("click",TextPolieren);
  document.getElementById("btnUndo").addEventListener("click",TextUndoPolieren);
  document.getElementById("btnPlus").addEventListener("click",KlientHinzufuegenDialog);
  document.getElementById("btnExport").addEventListener("click",KlientExportieren);
  document.getElementById("btnMinus").addEventListener("click",KlientLoeschenDialog);
  document.getElementById("btnNeuOK").addEventListener("click",KlientHinzufuegenOK);
  document.getElementById("inputNeuKlient").addEventListener("keydown",function(e){if(e.key==="Enter")KlientHinzufuegenOK();});
  document.getElementById("btnSpeichernOK").addEventListener("click",SpeicherDialogOK);
  document.getElementById("btnJaLoeschen").addEventListener("click",function(){EchtLoeschen();closeDlg("dlgLoeschen");});
  document.querySelectorAll(".modal-overlay").forEach(function(el){
    el.addEventListener("click",function(e){if(e.target===el)el.classList.remove("visible");});
  });
}

function KlientHistorieLaden(){
  var pfad=gewaehlterKlient+".txt";
  if(!fileExists(pfad)){txtLiveTranskript.value="";return;}
  var e=readFile(pfad).split("\n\n");
  txtLiveTranskript.value=e.slice(0,5).join("\n\n")+"\n\n";
}

function FinalSpeichern(art,dauer){
  var j=new Date();
  var datum=j.toLocaleDateString("de-DE");
  var zeit=j.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
  var eintrag=datum+", "+zeit+" Uhr | "+art+" | "+dauer+" Std.\n"+sessionText.trim()+"\n\n";
  var pfad=gewaehlterKlient+".txt";
  var alt=fileExists(pfad)?readFile(pfad):"";
  writeFile(pfad,eintrag+alt);
  KlientHistorieLaden();
}

function SprechenToggle(){
  if(gewaehlterKlient==="KLIENT W√ÑHLEN"){showPopup("W√§hle Klient!");return;}
  if(!speech){showPopup("Spracherkennung nicht verf√ºgbar!");return;}
  if(!isListening){
    isListening=true; sessionText="";
    txtStatus.textContent="INITIALISIERE..."; txtStatus.classList.remove("active");
    if(navigator.vibrate)navigator.vibrate([80]);
    speech.start();
  } else {
    isListening=false; speech.stop();
    btnMic.classList.remove("listening");
    txtStatus.textContent="BEREIT"; txtStatus.classList.remove("active");
    setTimeout(ZeigeSpeicherDialog,1200);
  }
}

function SpracheErkannt(res){sessionText+=(sessionText.length>0?" ":"")+res[0];}

function ZeigeSpeicherDialog(){if(!sessionText)return;openDlg("dlgSpeichern");}

function SpeicherDialogOK(){
  FinalSpeichern(document.getElementById("spinArt").value,document.getElementById("spinDauer").value);
  closeDlg("dlgSpeichern");
}

function KlientWaehlen(){
  if(!klientenArray.length){showPopup("Keine Klienten!");return;}
  var liste=document.getElementById("klientenListe");
  liste.innerHTML="";
  klientenArray.forEach(function(name){
    var el=document.createElement("div");
    el.className="klienten-item"; el.textContent=name;
    el.addEventListener("click",function(){
      gewaehlterKlient=name; btnSelectKlient.textContent=name;
      KlientHistorieLaden(); closeDlg("dlgKlienten");
    });
    liste.appendChild(el);
  });
  openDlg("dlgKlienten");
}

function KlientExportieren(){
  var pfad=gewaehlterKlient+".txt";
  if(!fileExists(pfad)){showPopup("Keine Datei f√ºr diesen Klienten.");return;}
  var inhalt=readFile(pfad);
  var dateiname="SAPP_"+gewaehlterKlient+".txt";
  if(navigator.share){
    navigator.share({title:"SAPP ‚Äì "+gewaehlterKlient,text:inhalt,
      files:[new File([inhalt],dateiname,{type:"text/plain"})]})
    .catch(function(){downloadDatei(inhalt,dateiname);});
  } else {downloadDatei(inhalt,dateiname);}
}

function downloadDatei(inhalt,dateiname){
  var blob=new Blob([inhalt],{type:"text/plain;charset=utf-8"});
  var url=URL.createObjectURL(blob);
  var a=document.createElement("a"); a.href=url; a.download=dateiname; a.click();
  URL.revokeObjectURL(url); showPopup("Datei wird heruntergeladen...");
}

function LadeSAPPListen(){
  var raw=loadText("KlientenDaten","");
  try{klientenArray=JSON.parse(raw);}catch(e){klientenArray=[];}
  if(!Array.isArray(klientenArray))klientenArray=[];
}
function SpeichereSAPPListen(){saveText("KlientenDaten",JSON.stringify(klientenArray));}

function KlientHinzufuegenDialog(){
  document.getElementById("inputNeuKlient").value="";
  openDlg("dlgNeu");
  setTimeout(function(){document.getElementById("inputNeuKlient").focus();},200);
}

function KlientHinzufuegenOK(){
  var n=document.getElementById("inputNeuKlient").value.trim();
  if(n){
    if(klientenArray.indexOf(n)===-1){klientenArray.push(n);SpeichereSAPPListen();}
    gewaehlterKlient=n; btnSelectKlient.textContent=n; KlientHistorieLaden();
  }
  closeDlg("dlgNeu");
}

function KlientLoeschenDialog(){
  if(gewaehlterKlient==="KLIENT W√ÑHLEN")return;
  document.getElementById("txtWarnLoeschen").textContent=
    "M√∂chtest du \""+gewaehlterKlient+"\" und ALLE seine Protokolle wirklich unwiderruflich l√∂schen?";
  openDlg("dlgLoeschen");
}

function EchtLoeschen(){
  var pfad=gewaehlterKlient+".txt";
  if(fileExists(pfad))deleteFile(pfad);
  var i=klientenArray.indexOf(gewaehlterKlient);
  if(i>-1){
    klientenArray.splice(i,1); SpeichereSAPPListen();
    gewaehlterKlient="KLIENT W√ÑHLEN"; btnSelectKlient.textContent=gewaehlterKlient;
    txtLiveTranskript.value=""; showPopup("Gel√∂scht!");
  }
}

function TextPolieren(){
  var pfad=gewaehlterKlient+".txt";
  if(!fileExists(pfad))return;
  var t=readFile(pfad); letzterText=t;
  t=t.replace(/\s+punkt\b/gi,".").replace(/\s+komma\b/gi,",").replace(/\s+fragezeichen\b/gi,"?");
  t=t.replace(/([.!?:]\s+)([a-z])/g,function(m,p1,p2){return p1+p2.toUpperCase();});
  writeFile(pfad,t); KlientHistorieLaden(); showPopup("Text poliert!");
}

function TextUndoPolieren(){
  if(letzterText){
    writeFile(gewaehlterKlient+".txt",letzterText);
    KlientHistorieLaden(); letzterText=""; showPopup("R√ºckg√§ngig!");
  } else {showPopup("Nichts zum R√ºckg√§ngigmachen.");}
}

function openDlg(id){document.getElementById(id).classList.add("visible");}
function closeDlg(id){document.getElementById(id).classList.remove("visible");}

var toastTimer;
function showPopup(msg){
  var el=document.getElementById("toast"); el.textContent=msg; el.classList.add("show");
  clearTimeout(toastTimer); toastTimer=setTimeout(function(){el.classList.remove("show");},2200);
}

OnStart();
</script>
</body>
</html>
