<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>SAPP ‚Äì Soziale Arbeit Protokoll & Planung</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@400;600;700;900&display=swap');
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg:#121212; --bg2:#1e1e1e;
    --green:#388E3C; --green-dark:#2E7D32;
    --blue:#2196F3; --blue-dark:#1976D2;
    --red:#D32F2F; --red-dark:#C62828;
    --red-mic:#ff1744; --red-mic-dk:#d50000;
    --orange:#FF9800; --orange-dark:#F57C00;
    --slate:#607D8B; --slate-dark:#455A64; --slate-darker:#37474F;
    --text:#ffffff; --text-dim:#666666; --radius:10px;
  }
  html,body { width:100%; height:100%; background:var(--bg); color:var(--text); font-family:'Barlow',sans-serif; overflow:hidden; display:flex; flex-direction:column; }
  #app { display:flex; flex-direction:column; width:100%; height:100%; }

  #layHeader { flex:0 0 12%; display:flex; align-items:center; justify-content:center; padding:2% 5% 1%; gap:8px; }
  #btnSelectKlient { flex:1; height:70%; background:linear-gradient(180deg,var(--green),var(--green-dark)); color:#fff; border:none; border-radius:var(--radius); font-family:'Barlow',sans-serif; font-size:clamp(13px,3.5vw,20px); font-weight:700; cursor:pointer; letter-spacing:.05em; transition:filter .15s; text-overflow:ellipsis; overflow:hidden; white-space:nowrap; padding:0 10px; }
  #btnSelectKlient:active { filter:brightness(.85); }
  #btnSettings { width:42px; height:42px; background:#2a2a2a; border:1px solid #444; border-radius:50%; color:#aaa; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:background .15s; }
  #btnSettings:active { background:#3a3a3a; }

  #layWork { flex:0 0 73%; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:1%; gap:8px; overflow:hidden; }
  #txtLogo { font-family:'Barlow',sans-serif; font-size:clamp(24px,7vw,35px); font-weight:900; color:var(--blue); letter-spacing:.15em; user-select:none; }

  #btnMic { width:min(45vw,140px); aspect-ratio:1; max-height:20vh; background:radial-gradient(circle at 35% 35%,var(--blue),var(--blue-dark)); border:2px solid var(--blue); border-radius:50%; color:#fff; font-size:clamp(36px,12vw,60px); cursor:pointer; transition:background .3s,border-color .3s,box-shadow .3s; display:flex; align-items:center; justify-content:center; user-select:none; flex-shrink:0; }
  #btnMic.listening { background:radial-gradient(circle at 35% 35%,var(--red-mic),var(--red-mic-dk)); border-color:var(--red-mic); animation:pulse-mic 1.2s infinite; }
  #btnMic.processing { background:radial-gradient(circle at 35% 35%,var(--orange),var(--orange-dark)); border-color:var(--orange); animation:none; }
  #btnMic:active { filter:brightness(.85); }
  @keyframes pulse-mic { 0%{box-shadow:0 0 0 0 rgba(255,23,68,.5)} 70%{box-shadow:0 0 0 18px rgba(255,23,68,0)} 100%{box-shadow:0 0 0 0 rgba(255,23,68,0)} }

  #txtStatus { font-family:'Share Tech Mono',monospace; font-size:clamp(11px,3vw,15px); color:var(--text-dim); letter-spacing:.1em; user-select:none; transition:color .3s; }
  #txtStatus.active { color:var(--red-mic); }
  #txtStatus.processing { color:var(--orange); }

  #recTimer { font-family:'Share Tech Mono',monospace; font-size:clamp(12px,3.5vw,18px); color:var(--red-mic); display:none; letter-spacing:.15em; }
  #recTimer.visible { display:block; }

  #txtLiveTranskript { width:90%; flex:1; min-height:0; background:var(--bg2); color:#fff; font-family:'Barlow',sans-serif; font-size:clamp(13px,3.5vw,15px); border:1px solid #333; border-radius:var(--radius); padding:10px 12px; resize:none; outline:none; line-height:1.5; }
  #txtLiveTranskript:focus { border-color:#555; }

  #layBtns { width:90%; display:flex; flex-direction:row; gap:2%; flex-shrink:0; height:6vh; min-height:36px; }
  .btn-action { flex:1; border:none; border-radius:var(--radius); font-family:'Barlow',sans-serif; font-weight:700; font-size:clamp(11px,3vw,14px); color:#fff; cursor:pointer; transition:filter .15s; letter-spacing:.03em; }
  .btn-action:active { filter:brightness(.8); }
  #btnClean { background:linear-gradient(180deg,var(--slate),var(--slate-dark)); }
  #btnUndo  { background:linear-gradient(180deg,var(--slate-dark),var(--slate-darker)); }

  #layBottom { flex:0 0 10%; display:flex; flex-direction:row; align-items:center; justify-content:center; gap:2%; padding:0 5%; }
  .btn-bottom { flex:1; height:70%; border:none; border-radius:var(--radius); font-family:'Barlow',sans-serif; font-weight:700; font-size:clamp(10px,2.8vw,13px); color:#fff; cursor:pointer; transition:filter .15s; letter-spacing:.02em; }
  .btn-bottom:active { filter:brightness(.8); }
  #btnPlus   { background:linear-gradient(180deg,var(--green),var(--green-dark)); }
  #btnExport { background:linear-gradient(180deg,var(--orange),var(--orange-dark)); }
  #btnMinus  { background:linear-gradient(180deg,var(--red),var(--red-dark)); }

  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:1000; align-items:center; justify-content:center; }
  .modal-overlay.visible { display:flex; }
  .modal-box { background:#1a1a1a; border:1px solid #333; border-radius:14px; width:min(88vw,420px); padding:20px 16px 16px; display:flex; flex-direction:column; gap:12px; animation:modal-in .2s ease; }
  @keyframes modal-in { from{transform:scale(.88);opacity:0} to{transform:scale(1);opacity:1} }
  .modal-title { font-family:'Share Tech Mono',monospace; font-size:18px; color:var(--blue); letter-spacing:.1em; border-bottom:1px solid #333; padding-bottom:8px; }
  .modal-label { font-size:14px; color:#aaa; margin-bottom:2px; }
  .modal-select { width:100%; background:var(--bg2); color:#fff; border:1px solid #444; border-radius:8px; padding:8px 10px; font-family:'Barlow',sans-serif; font-size:15px; outline:none; cursor:pointer; }
  .modal-select:focus { border-color:var(--blue); }
  .modal-input { width:100%; background:var(--bg2); color:#fff; border:1px solid #444; border-radius:8px; padding:10px 12px; font-family:'Barlow',sans-serif; font-size:15px; outline:none; }
  .modal-input:focus { border-color:var(--blue); }
  .modal-btn-row { display:flex; gap:8px; }
  .modal-btn { flex:1; padding:10px 8px; border:none; border-radius:8px; font-family:'Barlow',sans-serif; font-weight:700; font-size:14px; color:#fff; cursor:pointer; transition:filter .15s; letter-spacing:.03em; }
  .modal-btn:active { filter:brightness(.8); }
  .modal-btn.primary { background:var(--blue); }
  .modal-btn.danger  { background:var(--red); }
  .modal-btn.cancel  { background:var(--slate-dark); }
  .modal-btn.full    { flex:none; width:100%; background:var(--blue); }

  #klientenListe { max-height:45vh; overflow-y:auto; display:flex; flex-direction:column; gap:4px; }
  .klienten-item { background:var(--bg2); border:1px solid #333; border-radius:8px; padding:12px 14px; font-size:16px; cursor:pointer; transition:background .15s,border-color .15s; font-weight:600; }
  .klienten-item:hover,.klienten-item:active { background:#2a2a2a; border-color:var(--blue); }
  .warn-text { color:#ff0000; font-size:14px; line-height:1.5; }
  .settings-info { font-size:12px; color:#888; line-height:1.5; }
  .key-status { font-size:13px; font-family:'Share Tech Mono',monospace; }
  .key-status.ok { color:#4caf50; }
  .key-status.missing { color:#ff9800; }

  #toast { position:fixed; bottom:15%; left:50%; transform:translateX(-50%) translateY(10px); background:rgba(30,30,30,.97); color:#fff; padding:10px 20px; border-radius:20px; font-size:14px; font-family:'Barlow',sans-serif; font-weight:600; pointer-events:none; opacity:0; transition:opacity .25s,transform .25s; z-index:2000; white-space:nowrap; max-width:90vw; text-align:center; }
  #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
  ::-webkit-scrollbar { width:4px; }
  ::-webkit-scrollbar-track { background:#1a1a1a; }
  ::-webkit-scrollbar-thumb { background:#444; border-radius:4px; }
</style>
</head>
<body>

<div id="app">
  <div id="layHeader">
    <button id="btnSelectKlient">KLIENT W√ÑHLEN</button>
    <button id="btnSettings" title="Einstellungen">‚öôÔ∏è</button>
  </div>
  <div id="layWork">
    <div id="txtLogo">SAPP</div>
    <button id="btnMic">üé§</button>
    <div id="txtStatus">BEREIT</div>
    <div id="recTimer">‚è∫ 00:00</div>
    <textarea id="txtLiveTranskript" placeholder="Protokoll erscheint hier..."></textarea>
    <div id="layBtns">
      <button class="btn-action" id="btnClean">ü™Ñ POLIEREN</button>
      <button class="btn-action" id="btnUndo">‚Ü© UNDO</button>
    </div>
  </div>
  <div id="layBottom">
    <button class="btn-bottom" id="btnPlus">‚ûï NEU</button>
    <button class="btn-bottom" id="btnExport">üì§ TEILEN</button>
    <button class="btn-bottom" id="btnMinus">üóëÔ∏è L√ñSCHEN</button>
  </div>
</div>

<div class="modal-overlay" id="dlgKlienten">
  <div class="modal-box">
    <div class="modal-title">KLIENTEN</div>
    <div id="klientenListe"></div>
    <button class="modal-btn cancel" onclick="closeDlg('dlgKlienten')">SCHLIESSEN</button>
  </div>
</div>

<div class="modal-overlay" id="dlgNeu">
  <div class="modal-box">
    <div class="modal-title">NEU</div>
    <input class="modal-input" id="inputNeuKlient" type="text" placeholder="Klientenname eingeben...">
    <div class="modal-btn-row">
      <button class="modal-btn primary" id="btnNeuOK">OK</button>
      <button class="modal-btn cancel" onclick="closeDlg('dlgNeu')">ABBRECHEN</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="dlgSpeichern">
  <div class="modal-box">
    <div class="modal-title">DETAILS</div>
    <div class="modal-label">Ma√ünahme:</div>
    <select class="modal-select" id="spinArt">
      <option>Aufsuchend</option>
      <option>Begleitend</option>
      <option>B√ºro</option>
    </select>
    <div class="modal-label">Dauer:</div>
    <select class="modal-select" id="spinDauer">
      <option>0.5</option><option>1.0</option><option>1.5</option><option>2.0</option>
      <option>2.5</option><option>3.0</option><option>3.5</option><option>4.0</option>
    </select>
    <button class="modal-btn full" id="btnSpeichernOK">SPEICHERN</button>
  </div>
</div>

<div class="modal-overlay" id="dlgLoeschen">
  <div class="modal-box">
    <div class="modal-title">L√ñSCHEN BEST√ÑTIGEN</div>
    <p class="warn-text" id="txtWarnLoeschen"></p>
    <div class="modal-btn-row">
      <button class="modal-btn danger" id="btnJaLoeschen">JA, ALLES L√ñSCHEN</button>
      <button class="modal-btn cancel" onclick="closeDlg('dlgLoeschen')">ABBRECHEN</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="dlgSettings">
  <div class="modal-box">
    <div class="modal-title">‚öôÔ∏è EINSTELLUNGEN</div>
    <p class="settings-info">Dein API Key wird nur lokal in diesem Browser gespeichert ‚Äî nichts wird weitergeleitet au√üer direkt zu OpenAI f√ºr die Transkription.</p>
    <div class="modal-label">OpenAI API Key:</div>
    <input class="modal-input" id="inputApiKey" type="password" placeholder="sk-...">
    <div id="keyStatus" class="key-status missing">‚ö† Kein Key gespeichert</div>
    <div class="modal-btn-row">
      <button class="modal-btn primary" id="btnSaveKey">SPEICHERN</button>
      <button class="modal-btn danger" id="btnDeleteKey">L√ñSCHEN</button>
    </div>
    <button class="modal-btn cancel" onclick="closeDlg('dlgSettings')">SCHLIESSEN</button>
  </div>
</div>

<div id="toast"></div>

<script>
var mediaRecorder=null, audioChunks=[], isListening=false, isProcessing=false;
var sessionText="", gewaehlterKlient="KLIENT W√ÑHLEN", letzterText="", klientenArray=[];
var FILE_PREFIX="SAPP_FILE_", timerInterval=null, recSeconds=0;

var btnSelectKlient=document.getElementById("btnSelectKlient");
var btnMic=document.getElementById("btnMic");
var txtStatus=document.getElementById("txtStatus");
var txtLiveTranskript=document.getElementById("txtLiveTranskript");
var recTimer=document.getElementById("recTimer");

function fileExists(p){return localStorage.getItem(FILE_PREFIX+p)!==null;}
function readFile(p){return localStorage.getItem(FILE_PREFIX+p)||"";}
function writeFile(p,c){localStorage.setItem(FILE_PREFIX+p,c);}
function deleteFile(p){localStorage.removeItem(FILE_PREFIX+p);}
function loadText(k,fb){var v=localStorage.getItem(k);return v!==null?v:fb;}
function saveText(k,v){localStorage.setItem(k,v);}

function getApiKey(){return loadText("SAPP_OPENAI_KEY","");}
function saveApiKey(k){saveText("SAPP_OPENAI_KEY",k);}
function deleteApiKey(){localStorage.removeItem("SAPP_OPENAI_KEY");}

function updateKeyStatus(){
  var el=document.getElementById("keyStatus");
  if(getApiKey()){el.textContent="‚úì API Key gespeichert";el.className="key-status ok";}
  else{el.textContent="‚ö† Kein Key gespeichert";el.className="key-status missing";}
}

function startTimer(){
  recSeconds=0; recTimer.classList.add("visible");
  timerInterval=setInterval(function(){
    recSeconds++;
    var m=Math.floor(recSeconds/60),s=recSeconds%60;
    recTimer.textContent="‚è∫ "+(m<10?"0":"")+m+":"+(s<10?"0":"")+s;
  },1000);
}
function stopTimer(){clearInterval(timerInterval);recTimer.classList.remove("visible");recTimer.textContent="‚è∫ 00:00";}

function InitRecorder(callback){
  navigator.mediaDevices.getUserMedia({audio:true})
  .then(function(stream){
    var mimeType="audio/webm";
    if(MediaRecorder.isTypeSupported("audio/webm;codecs=opus"))mimeType="audio/webm;codecs=opus";
    mediaRecorder=new MediaRecorder(stream,{mimeType:mimeType});
    audioChunks=[];
    mediaRecorder.ondataavailable=function(e){if(e.data.size>0)audioChunks.push(e.data);};
    mediaRecorder.onstop=function(){
      stream.getTracks().forEach(function(t){t.stop();});
      var blob=new Blob(audioChunks,{type:mimeType});
      SendToWhisper(blob);
    };
    mediaRecorder.start(1000);
    callback(true);
  })
  .catch(function(){showPopup("Mikrofon-Zugriff verweigert!");callback(false);});
}

function SendToWhisper(audioBlob){
  var apiKey=getApiKey();
  if(!apiKey){showPopup("Kein API Key! Bitte in ‚öôÔ∏è eintragen.");SetzeStatusBereit();return;}
  btnMic.classList.remove("listening"); btnMic.classList.add("processing");
  btnMic.textContent="‚è≥";
  txtStatus.textContent="WHISPER VERARBEITET..."; txtStatus.className="processing";
  isProcessing=true;
  var formData=new FormData();
  var ext=audioBlob.type.includes("webm")?"webm":"mp4";
  formData.append("file",audioBlob,"aufnahme."+ext);
  formData.append("model","whisper-1");
  formData.append("language","de");
  fetch("https://api.openai.com/v1/audio/transcriptions",{
    method:"POST",
    headers:{"Authorization":"Bearer "+apiKey},
    body:formData
  })
  .then(function(r){if(!r.ok)return r.json().then(function(e){throw new Error(e.error.message);});return r.json();})
  .then(function(data){
    var text=data.text?data.text.trim():"";
    if(text){sessionText+=(sessionText.length>0?" ":"")+text;txtLiveTranskript.value=sessionText;}
    SetzeStatusBereit(); setTimeout(ZeigeSpeicherDialog,600);
  })
  .catch(function(err){showPopup("Fehler: "+err.message);SetzeStatusBereit();});
}

function SetzeStatusBereit(){
  isProcessing=false;
  btnMic.classList.remove("listening","processing");
  btnMic.textContent="üé§";
  txtStatus.textContent="BEREIT"; txtStatus.className="";
}

function SprechenToggle(){
  if(isProcessing)return;
  if(gewaehlterKlient==="KLIENT W√ÑHLEN"){showPopup("W√§hle zuerst einen Klienten!");return;}
  if(!getApiKey()){showPopup("Bitte zuerst API Key in ‚öôÔ∏è eintragen!");openDlg("dlgSettings");return;}
  if(!isListening){
    isListening=true; sessionText="";
    txtStatus.textContent="INITIALISIERE...";
    if(navigator.vibrate)navigator.vibrate([80]);
    InitRecorder(function(ok){
      if(ok){startTimer();btnMic.classList.add("listening");txtStatus.textContent="SAPP H√ñRT ZU...";txtStatus.classList.add("active");}
      else{isListening=false;SetzeStatusBereit();}
    });
  } else {
    isListening=false; stopTimer();
    txtStatus.textContent="SENDE ZU WHISPER...";
    if(mediaRecorder&&mediaRecorder.state!=="inactive")mediaRecorder.stop();
  }
}

function ZeigeSpeicherDialog(){if(!sessionText)return;openDlg("dlgSpeichern");}
function SpeicherDialogOK(){FinalSpeichern(document.getElementById("spinArt").value,document.getElementById("spinDauer").value);closeDlg("dlgSpeichern");}

function KlientHistorieLaden(){
  var pfad=gewaehlterKlient+".txt";
  if(!fileExists(pfad)){txtLiveTranskript.value="";return;}
  var e=readFile(pfad).split("\n\n");
  txtLiveTranskript.value=e.slice(0,5).join("\n\n")+"\n\n";
}

function FinalSpeichern(art,dauer){
  var j=new Date();
  var datum=j.toLocaleDateString("de-DE");
  var zeit=j.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
  var eintrag=datum+", "+zeit+" Uhr | "+art+" | "+dauer+" Std.\n"+sessionText.trim()+"\n\n";
  var pfad=gewaehlterKlient+".txt";
  var alt=fileExists(pfad)?readFile(pfad):"";
  writeFile(pfad,eintrag+alt); KlientHistorieLaden();
}

function KlientWaehlen(){
  if(!klientenArray.length){showPopup("Keine Klienten!");return;}
  var liste=document.getElementById("klientenListe"); liste.innerHTML="";
  klientenArray.forEach(function(name){
    var el=document.createElement("div"); el.className="klienten-item"; el.textContent=name;
    el.addEventListener("click",function(){gewaehlterKlient=name;btnSelectKlient.textContent=name;KlientHistorieLaden();closeDlg("dlgKlienten");});
    liste.appendChild(el);
  });
  openDlg("dlgKlienten");
}

function KlientHinzufuegenDialog(){document.getElementById("inputNeuKlient").value="";openDlg("dlgNeu");setTimeout(function(){document.getElementById("inputNeuKlient").focus();},200);}

function KlientHinzufuegenOK(){
  var n=document.getElementById("inputNeuKlient").value.trim();
  if(n){if(klientenArray.indexOf(n)===-1){klientenArray.push(n);SpeichereSAPPListen();}gewaehlterKlient=n;btnSelectKlient.textContent=n;KlientHistorieLaden();}
  closeDlg("dlgNeu");
}

function KlientLoeschenDialog(){
  if(gewaehlterKlient==="KLIENT W√ÑHLEN")return;
  document.getElementById("txtWarnLoeschen").textContent="M√∂chtest du \""+gewaehlterKlient+"\" und ALLE seine Protokolle wirklich unwiderruflich l√∂schen?";
  openDlg("dlgLoeschen");
}

function EchtLoeschen(){
  var pfad=gewaehlterKlient+".txt";
  if(fileExists(pfad))deleteFile(pfad);
  var i=klientenArray.indexOf(gewaehlterKlient);
  if(i>-1){klientenArray.splice(i,1);SpeichereSAPPListen();gewaehlterKlient="KLIENT W√ÑHLEN";btnSelectKlient.textContent=gewaehlterKlient;txtLiveTranskript.value="";showPopup("Gel√∂scht!");}
}

function KlientExportieren(){
  var pfad=gewaehlterKlient+".txt";
  if(!fileExists(pfad)){showPopup("Keine Datei f√ºr diesen Klienten.");return;}
  var inhalt=readFile(pfad), dateiname="SAPP_"+gewaehlterKlient+".txt";
  if(navigator.share){navigator.share({title:"SAPP ‚Äì "+gewaehlterKlient,text:inhalt,files:[new File([inhalt],dateiname,{type:"text/plain"})]}).catch(function(){downloadDatei(inhalt,dateiname);});}
  else{downloadDatei(inhalt,dateiname);}
}

function downloadDatei(inhalt,dateiname){
  var blob=new Blob([inhalt],{type:"text/plain;charset=utf-8"});
  var url=URL.createObjectURL(blob),a=document.createElement("a");
  a.href=url;a.download=dateiname;a.click();URL.revokeObjectURL(url);
  showPopup("Datei wird heruntergeladen...");
}

function LadeSAPPListen(){var raw=loadText("KlientenDaten","");try{klientenArray=JSON.parse(raw);}catch(e){klientenArray=[];}if(!Array.isArray(klientenArray))klientenArray=[];}
function SpeichereSAPPListen(){saveText("KlientenDaten",JSON.stringify(klientenArray));}

function TextPolieren(){
  var pfad=gewaehlterKlient+".txt"; if(!fileExists(pfad))return;
  var t=readFile(pfad); letzterText=t;
  t=t.replace(/\s+punkt\b/gi,".").replace(/\s+komma\b/gi,",").replace(/\s+fragezeichen\b/gi,"?");
  t=t.replace(/([.!?:]\s+)([a-z])/g,function(m,p1,p2){return p1+p2.toUpperCase();});
  writeFile(pfad,t); KlientHistorieLaden(); showPopup("Text poliert!");
}

function TextUndoPolieren(){
  if(letzterText){writeFile(gewaehlterKlient+".txt",letzterText);KlientHistorieLaden();letzterText="";showPopup("R√ºckg√§ngig!");}
  else{showPopup("Nichts zum R√ºckg√§ngigmachen.");}
}

function openDlg(id){document.getElementById(id).classList.add("visible");}
function closeDlg(id){document.getElementById(id).classList.remove("visible");}

var toastTimer;
function showPopup(msg){var el=document.getElementById("toast");el.textContent=msg;el.classList.add("show");clearTimeout(toastTimer);toastTimer=setTimeout(function(){el.classList.remove("show");},2500);}

function EventListeners(){
  btnSelectKlient.addEventListener("click",KlientWaehlen);
  btnMic.addEventListener("click",SprechenToggle);
  document.getElementById("btnClean").addEventListener("click",TextPolieren);
  document.getElementById("btnUndo").addEventListener("click",TextUndoPolieren);
  document.getElementById("btnPlus").addEventListener("click",KlientHinzufuegenDialog);
  document.getElementById("btnExport").addEventListener("click",KlientExportieren);
  document.getElementById("btnMinus").addEventListener("click",KlientLoeschenDialog);
  document.getElementById("btnSettings").addEventListener("click",function(){document.getElementById("inputApiKey").value="";updateKeyStatus();openDlg("dlgSettings");});
  document.getElementById("btnSaveKey").addEventListener("click",function(){var k=document.getElementById("inputApiKey").value.trim();if(k){saveApiKey(k);updateKeyStatus();showPopup("API Key gespeichert!");}else{showPopup("Bitte Key eingeben.");}});
  document.getElementById("btnDeleteKey").addEventListener("click",function(){deleteApiKey();updateKeyStatus();showPopup("Key gel√∂scht.");});
  document.getElementById("btnNeuOK").addEventListener("click",KlientHinzufuegenOK);
  document.getElementById("inputNeuKlient").addEventListener("keydown",function(e){if(e.key==="Enter")KlientHinzufuegenOK();});
  document.getElementById("btnSpeichernOK").addEventListener("click",SpeicherDialogOK);
  document.getElementById("btnJaLoeschen").addEventListener("click",function(){EchtLoeschen();closeDlg("dlgLoeschen");});
  document.querySelectorAll(".modal-overlay").forEach(function(el){el.addEventListener("click",function(e){if(e.target===el)el.classList.remove("visible");});});
}

function OnStart(){
  LadeSAPPListen(); EventListeners();
  if(!getApiKey())setTimeout(function(){showPopup("‚öôÔ∏è Bitte API Key in Einstellungen eintragen!");},800);
}

OnStart();
</script>
</body>
</html>
