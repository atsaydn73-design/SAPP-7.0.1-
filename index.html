<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>SAPP 7.1 PRO</title>
    <style>
        /* ORIGINAL SAPP 7.0 LOOK */
        :root { --bg: #121212; --card: #1e1e1e; --green: #2E7D32; --blue: #2196F3; --red: #D32F2F; --orange: #F57C00; --gray: #455A64; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { background-color: var(--bg); color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { height: 10%; display: flex; justify-content: center; align-items: center; padding: 10px; }
        #btnSelectKlient { background: var(--green); color: white; border: none; width: 90%; height: 45px; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }

        /* ARBEITSBEREICH */
        main { height: 75%; display: flex; flex-direction: column; align-items: center; justify-content: space-around; padding: 10px; }
        .logo { font-size: 26px; font-weight: bold; color: var(--blue); }
        
        .mic-btn { width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--blue); background: transparent; color: var(--blue); font-size: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.3s; }
        .mic-btn.active { background: var(--red); border-color: var(--red); color: white; box-shadow: 0 0 20px rgba(211, 47, 47, 0.5); }
        
        #txtStatus { font-weight: bold; color: #666; font-size: 14px; text-transform: uppercase; }

        #txtLiveTranskript { width: 90%; height: 160px; background: var(--card); color: white; border: none; border-radius: 10px; padding: 15px; font-size: 16px; overflow-y: auto; line-height: 1.5; white-space: pre-wrap; border: 1px solid #333; }

        /* EDIT ZEILE */
        .edit-row { width: 90%; display: flex; gap: 5px; }
        .btn-small { flex: 1; padding: 8px; border: none; border-radius: 5px; color: white; font-weight: bold; font-size: 11px; background: var(--gray); cursor: pointer; }

        /* UNTERE LEISTE */
        footer { height: 15%; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; }
        .btn-bottom { width: 30%; height: 50px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 13px; cursor: pointer; }

        /* MODAL / DIALOG */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); width: 85%; padding: 25px; border-radius: 20px; border: 1px solid var(--blue); }
        .modal-content h3 { margin-bottom: 20px; color: var(--blue); text-align: center; }
        select, input[type="text"] { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; background: #111; color: white; border: 1px solid #444; font-size: 16px; }
    </style>
</head>
<body>

    <header>
        <button id="btnSelectKlient" onclick="openKlientenWahl()">KLIENT W√ÑHLEN</button>
    </header>

    <main>
        <div class="logo">SAPP</div>
        
        <button id="btnMic" class="mic-btn" onclick="toggleSpeech()">üéôÔ∏è</button>
        <div id="txtStatus">BEREIT</div>

        <div id="txtLiveTranskript" contenteditable="false"></div>

        <div class="edit-row">
            <button class="btn-small" id="btnEdit" onclick="toggleEdit()">üìù EDIT</button>
            <button class="btn-small" onclick="polieren()">ü™Ñ POLIEREN</button>
            <button class="btn-small" onclick="undo()">‚Ü© UNDO</button>
        </div>
    </main>

    <footer>
        <button class="btn-bottom" style="background:var(--green)" onclick="openNeuModal()">‚ûï NEU</button>
        <button class="btn-bottom" style="background:var(--orange)" onclick="teilen()">üì§ TEILEN</button>
        <button class="btn-bottom" style="background:var(--red)" onclick="klientLoeschen()">üóëÔ∏è L√ñSCHEN</button>
    </footer>

    <div id="modal">
        <div class="modal-content" id="modal-details">
            <h3>DETAILS</h3>
            <label style="font-size:12px; color:#888">MA·∫ûNAHME:</label>
            <select id="spinArt">
                <option>Aufsuchend</option>
                <option>Begleitend</option>
                <option>B√ºro</option>
            </select>
            <label style="font-size:12px; color:#888">DAUER (STUNDEN):</label>
            <select id="spinDauer">
                <option>0.5</option><option>1.0</option><option>1.5</option>
                <option>2.0</option><option>2.5</option><option>3.0</option>
            </select>
            <button class="btn-bottom" style="width:100%; margin-top:10px; background:var(--blue)" onclick="finalSpeichern()">SPEICHERN</button>
        </div>

        <div class="modal-content" id="modal-klienten" style="display:none">
            <h3>KLIENTEN</h3>
            <div id="klientenListe" style="max-height: 200px; overflow-y: auto;"></div>
            <button class="btn-small" style="width:100%; margin-top:15px;" onclick="closeModal()">SCHLIE·∫ûEN</button>
        </div>

        <div class="modal-content" id="modal-neu" style="display:none">
            <h3>NEUER KLIENT</h3>
            <input type="text" id="inputNeuName" placeholder="Name eingeben...">
            <button class="btn-bottom" style="width:100%; background:var(--green)" onclick="klientHinzufuegen()">HINZUF√úGEN</button>
        </div>
    </div>

    <script>
        let clients = JSON.parse(localStorage.getItem('sapp_clients')) || [];
        let activeClient = null;
        let isRecording = false;
        let isEditing = false;
        let sessionText = "";
        let historyUndo = "";

        // SPRACHERKENNUNG (Stabil-Modus)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;

        if(recognition) {
            recognition.lang = 'de-DE';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.onresult = (event) => {
                let interim = "";
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    interim += event.results[i][0].transcript;
                }
                sessionText = interim;
                updateDisplay();
            };
            recognition.onend = () => { if(isRecording) recognition.start(); };
        }

        function toggleSpeech() {
            if(!activeClient) return alert("W√§hle Klient!");
            const btn = document.getElementById('btnMic');
            const status = document.getElementById('txtStatus');

            if(!isRecording) {
                isRecording = true;
                sessionText = "";
                recognition.start();
                btn.classList.add('active');
                status.innerText = "SAPP H√ñRT ZU...";
            } else {
                isRecording = false;
                recognition.stop();
                btn.classList.remove('active');
                status.innerText = "BEREIT";
                if(sessionText.trim() !== "") openModal('details');
            }
        }

        // SPEICHER-LOGIK (Original DroidScript Format)
        function finalSpeichern() {
            const art = document.getElementById('spinArt').value;
            const dauer = document.getElementById('spinDauer').value;
            const j = new Date();
            const datum = j.toLocaleDateString('de-DE');
            const zeit = j.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            // Abk√ºrzungen wie in 7.0
            const artK = art.replace("Aufsuchend", "Aufs.").replace("Begleitend", "Begl.");
            const eintrag = `${datum}, ${zeit} | ${artK} | ${dauer}h\n${sessionText.trim()}\n\n`;
            
            const alterText = localStorage.getItem('sapp_data_' + activeClient) || "";
            localStorage.setItem('sapp_data_' + activeClient, eintrag + alterText);
            
            closeModal();
            loadHistory();
        }

        // UI FUNKTIONEN
        function updateDisplay() {
            const area = document.getElementById('txtLiveTranskript');
            const alterText = localStorage.getItem('sapp_data_' + activeClient) || "";
            area.innerText = (sessionText ? sessionText + "\n\n" : "") + alterText;
        }

        function loadHistory() {
            if(!activeClient) return;
            const t = localStorage.getItem('sapp_data_' + activeClient) || "";
            document.getElementById('txtLiveTranskript').innerText = t;
        }

        function polieren() {
            let t = document.getElementById('txtLiveTranskript').innerText;
            historyUndo = t;
            t = t.replace(/\s+punkt\b/gi, ".").replace(/\s+komma\b/gi, ",").replace(/\s+fragezeichen\b/gi, "?");
            t = t.replace(/([.!?:]\s+)([a-z])/g, (m, p1, p2) => p1 + p2.toUpperCase());
            document.getElementById('txtLiveTranskript').innerText = t;
            if(activeClient) localStorage.setItem('sapp_data_' + activeClient, t);
        }

        function undo() {
            if(historyUndo) {
                document.getElementById('txtLiveTranskript').innerText = historyUndo;
                localStorage.setItem('sapp_data_' + activeClient, historyUndo);
                historyUndo = "";
            }
        }

        function toggleEdit() {
            isEditing = !isEditing;
            const area = document.getElementById('txtLiveTranskript');
            const btn = document.getElementById('btnEdit');
            area.contentEditable = isEditing;
            if(isEditing) {
                area.focus();
                btn.innerText = "üíæ OK";
                btn.style.background = "var(--green)";
            } else {
                localStorage.setItem('sapp_data_' + activeClient, area.innerText);
                btn.innerText = "üìù EDIT";
                btn.style.background = "var(--gray)";
            }
        }

        // MODAL MANAGEMENT
        function openModal(type) {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-details').style.display = type === 'details' ? 'block' : 'none';
            document.getElementById('modal-klienten').style.display = type === 'klienten' ? 'block' : 'none';
            document.getElementById('modal-neu').style.display = type === 'neu' ? 'block' : 'none';
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function openKlientenWahl() {
            const liste = document.getElementById('klientenListe');
            liste.innerHTML = "";
            clients.forEach(c => {
                const div = document.createElement('div');
                div.style = "padding:15px; border-bottom:1px solid #333; font-weight:bold;";
                div.innerText = c;
                div.onclick = () => { activeClient = c; document.getElementById('btnSelectKlient').innerText = c; loadHistory(); closeModal(); };
                liste.appendChild(div);
            });
            openModal('klienten');
        }

        function openNeuModal() { openModal('neu'); }

        function klientHinzufuegen() {
            const name = document.getElementById('inputNeuName').value;
            if(name) {
                clients.push(name);
                localStorage.setItem('sapp_clients', JSON.stringify(clients));
                document.getElementById('inputNeuName').value = "";
                closeModal();
                alert(name + " hinzugef√ºgt.");
            }
        }

        function klientLoeschen() {
            if(!activeClient) return;
            if(confirm(activeClient + " wirklich l√∂schen?")) {
                clients = clients.filter(c => c !== activeClient);
                localStorage.setItem('sapp_clients', JSON.stringify(clients));
                localStorage.removeItem('sapp_data_' + activeClient);
                activeClient = null;
                document.getElementById('btnSelectKlient').innerText = "KLIENT W√ÑHLEN";
                document.getElementById('txtLiveTranskript').innerText = "";
            }
        }

        function teilen() {
            const t = document.getElementById('txtLiveTranskript').innerText;
            if(!t) return;
            const blob = new Blob([t], {type: 'text/plain'});
            const file = new File([blob], `SAPP_${activeClient}.txt`, {type: 'text/plain'});
            if(navigator.canShare && navigator.canShare({files: [file]})) {
                navigator.share({ files: [file], title: 'SAPP Protokoll' });
            } else {
                alert("Teilen wird von diesem Browser nicht unterst√ºtzt. Kopiere den Text manuell.");
            }
        }
    </script>
</body>
</html>
