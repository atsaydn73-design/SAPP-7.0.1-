<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>SAPP 8.5 PRO</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Barlow+Condensed:wght@400;600;700&display=swap');

        :root {
            --bg: #0a0a0a;
            --card: #161616;
            --card2: #1e1e1e;
            --blue: #00aaff;
            --green: #28a745;
            --red: #dc3545;
            --orange: #fd7e14;
            --text: #e0e0e0;
            --muted: #555;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg);
            color: var(--text);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'Barlow Condensed', sans-serif;
        }

        /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
        header {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #222;
            background: #0e0e0e;
            flex-shrink: 0;
        }
        .client-btn {
            background: var(--green);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.5px;
        }
        #activeClientDisplay {
            color: var(--blue);
            font-weight: 700;
            font-size: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Barlow Condensed', sans-serif;
        }

        /* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
        main {
            flex: 1;
            padding: 12px 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ‚îÄ‚îÄ‚îÄ AUFNAHME-BOX ‚îÄ‚îÄ‚îÄ */
        #recordingBox {
            background: #0f1a24;
            border: 2px solid var(--blue);
            border-radius: 10px;
            padding: 14px;
            min-height: 110px;
            font-size: 16px;
            line-height: 1.6;
            display: none;
            position: relative;
            font-family: 'Barlow Condensed', sans-serif;
            color: #fff;
            outline: none;
            cursor: text;
        }
        #recordingBox:focus {
            border-color: #00ccff;
            box-shadow: 0 0 0 3px rgba(0,170,255,0.15);
        }
        /* Interim-Text (grauer Vorschau-Text) */
        #recordingBox .interim {
            color: #666;
            font-style: italic;
        }

        /* ‚îÄ‚îÄ‚îÄ EDIT-HINWEIS ‚îÄ‚îÄ‚îÄ */
        #editHint {
            display: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--orange);
            text-align: center;
            padding: 4px;
        }

        /* ‚îÄ‚îÄ‚îÄ VERLAUF ‚îÄ‚îÄ‚îÄ */
        .history-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .entry-card {
            background: var(--card);
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid var(--blue);
        }
        .entry-header {
            display: flex;
            justify-content: space-between;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--orange);
            margin-bottom: 6px;
            font-weight: 700;
        }
        .entry-text {
            font-size: 14px;
            line-height: 1.5;
            color: #ccc;
        }

        /* ‚îÄ‚îÄ‚îÄ STEUERUNG ‚îÄ‚îÄ‚îÄ */
        .controls {
            padding: 15px 20px;
            text-align: center;
            border-top: 1px solid #1a1a1a;
            background: #0d0d0d;
            flex-shrink: 0;
        }
        .mic-btn {
            width: 78px;
            height: 78px;
            border-radius: 50%;
            border: none;
            background: var(--blue);
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 0 0 0 rgba(0,170,255,0);
        }
        .mic-btn:active { transform: scale(0.95); }
        .mic-btn.active {
            background: var(--red);
            box-shadow: 0 0 22px rgba(220,53,69,0.55);
            transform: scale(1.05);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%   { box-shadow: 0 0 0 0 rgba(220,53,69,0.6); }
            70%  { box-shadow: 0 0 0 12px rgba(220,53,69,0); }
            100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); }
        }

        #statusInfo {
            margin-top: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--muted);
            letter-spacing: 0.5px;
            min-height: 16px;
            transition: color 0.3s;
        }
        #statusInfo.ok    { color: var(--green); }
        #statusInfo.rec   { color: var(--red); }
        #statusInfo.warn  { color: var(--orange); }
        #statusInfo.err   { color: var(--red); }
        #wordCount {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: #444;
            margin-top: 3px;
        }

        /* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
        footer {
            height: 60px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #000;
            padding-bottom: env(safe-area-inset-bottom);
            border-top: 1px solid #1a1a1a;
            flex-shrink: 0;
        }
        .f-btn {
            background: none;
            border: none;
            color: #555;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            padding: 8px 12px;
            letter-spacing: 0.5px;
        }
        .f-btn:active { opacity: 0.6; }

        /* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--card2);
            border-radius: 12px;
            padding: 22px;
            width: 100%;
            max-width: 360px;
            border: 1px solid #2a2a2a;
        }
        .modal-content h3 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 18px;
            color: var(--blue);
            text-align: center;
            margin-bottom: 15px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: #888;
            display: block;
            margin-top: 12px;
        }
        select, input {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border-radius: 7px;
            background: #0a0a0a;
            color: white;
            border: 1px solid #333;
            font-size: 16px;
            font-family: 'Barlow Condensed', sans-serif;
            outline: none;
        }
        select:focus, input:focus { border-color: var(--blue); }
        .save-btn {
            width: 100%;
            padding: 14px;
            border-radius: 7px;
            border: none;
            color: white;
            font-weight: 700;
            font-size: 15px;
            font-family: 'Barlow Condensed', sans-serif;
            background: var(--green);
            margin-top: 14px;
            cursor: pointer;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: opacity 0.2s;
        }
        .save-btn:active { opacity: 0.8; }
    </style>
</head>
<body>

    <header>
        <button class="client-btn" onclick="openModal('klienten')">KLIENT W√ÑHLEN</button>
        <div id="activeClientDisplay">KEIN KLIENT</div>
    </header>

    <main>
        <!-- Aufnahme-Box: contenteditable erst NACH dem Stopp aktiviert -->
        <div id="recordingBox" contenteditable="false"></div>
        <div id="editHint">‚úèÔ∏è AUFNAHME GESTOPPT ‚Äì TEXT BEARBEITBAR</div>
        <div class="history-label">Verlauf (Letzte 5 Eintr√§ge)</div>
        <div id="historyList"></div>
    </main>

    <div class="controls">
        <button id="btnMic" class="mic-btn" onclick="toggleSpeech()">üéôÔ∏è</button>
        <div id="statusInfo">BEREIT</div>
        <div id="wordCount"></div>
    </div>

    <footer>
        <button class="f-btn" onclick="openModal('neu')">‚ûï NEU</button>
        <button class="f-btn" style="color:var(--blue)" onclick="exportToDrive()">üíæ DRIVE</button>
        <button class="f-btn" style="color:var(--red)" onclick="loescheKlient()">üóëÔ∏è L√ñSCHEN</button>
    </footer>

    <!-- DETAILS MODAL -->
    <div id="modalDetails" class="modal">
        <div class="modal-content">
            <h3>Details erfassen</h3>
            <label>MA·∫ûNAHME:</label>
            <select id="selArt">
                <option value="Aufs.">Aufsuchend</option>
                <option value="Begl.">Begleitend</option>
                <option value="B√ºro">B√ºro / Telefon</option>
                <option value="Doku">Dokumentation</option>
            </select>
            <label>DAUER:</label>
            <select id="selDauer">
                <option value="0.25">0.25h</option>
                <option value="0.50">0.50h</option>
                <option value="0.75">0.75h</option>
                <option value="1.00">1.00h</option>
                <option value="1.50">1.50h</option>
                <option value="2.00">2.00h</option>
            </select>
            <button class="save-btn" onclick="finalSave()">SPEICHERN</button>
            <button class="save-btn" style="background:#333; margin-top:6px;" onclick="closeModals()">ABBRECHEN</button>
        </div>
    </div>

    <!-- KLIENTEN MODAL -->
    <div id="modalKlienten" class="modal">
        <div class="modal-content">
            <h3>Klienten</h3>
            <div id="kList"></div>
            <button class="save-btn" style="background:#2a2a2a; margin-top:14px;" onclick="closeModals()">ZUR√úCK</button>
        </div>
    </div>

    <!-- NEU MODAL -->
    <div id="modalNeu" class="modal">
        <div class="modal-content">
            <h3>Neuen Klienten anlegen</h3>
            <label>NAME:</label>
            <input type="text" id="nInput" placeholder="Vor- und Nachname...">
            <button class="save-btn" onclick="addClient()">ANLEGEN</button>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ DATENBANK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let db = JSON.parse(localStorage.getItem('sapp_85_db')) || { clients: {}, active: null };

        // ‚îÄ‚îÄ‚îÄ ZUSTANDSFLAGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // isRecording = User hat Aufnahme gestartet (UI-Zustand)
        // canRestart  = darf onend automatisch neu starten?
        // Diese Trennung verhindert die Race Condition zwischen onerror und onend
        let isRecording = false;
        let canRestart  = false;

        // ‚îÄ‚îÄ‚îÄ SPEECH RECOGNITION SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!SpeechRec) {
            document.getElementById('statusInfo').textContent = '‚ùå Browser unterst√ºtzt keine Spracherkennung';
            document.getElementById('statusInfo').className = 'err';
            document.getElementById('btnMic').disabled = true;
        }

        const recognition = SpeechRec ? new SpeechRec() : null;

        if (recognition) {
            recognition.lang            = 'de-DE';
            recognition.continuous      = true;
            recognition.interimResults  = true;
            recognition.maxAlternatives = 1;

            let finalText = "";

            // ‚îÄ‚îÄ‚îÄ onresult: isFinal-Trennung, nur ab resultIndex ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            recognition.onresult = (event) => {
                let interim = "";
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalText += transcript + " ";
                    } else {
                        interim += transcript;
                    }
                }
                const box = document.getElementById('recordingBox');
                box.style.display = "block";
                box.innerHTML =
                    escapeHtml(finalText) +
                    (interim ? `<span class="interim">${escapeHtml(interim)}</span>` : "");

                const wc = finalText.trim().split(/\s+/).filter(Boolean).length;
                document.getElementById('wordCount').textContent =
                    wc > 0 ? `${wc} W√∂rter erfasst` : "";
            };

            // ‚îÄ‚îÄ‚îÄ onerror: ERST canRestart killen, DANN UI anpassen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Reihenfolge ist kritisch: canRestart muss false sein bevor
            // onend feuert, sonst startet der Auto-Restart trotz Fehler
            recognition.onerror = (event) => {
                console.error("SR Fehler:", event.error);

                const FATAL = ['not-allowed', 'audio-capture'];
                const isFatal = FATAL.includes(event.error);

                // Bei fatalen Fehlern: SOFORT canRestart sperren
                // (synchron, bevor onend feuern kann)
                if (isFatal) {
                    canRestart  = false;
                    isRecording = false;
                }

                const errMsgs = {
                    'not-allowed'   : '‚ùå MIKRO VERWEIGERT ‚Äì Chrome-Einstellungen pr√ºfen',
                    'no-speech'     : '‚ö†Ô∏è KEIN SIGNAL ‚Äì Bitte sprechen',
                    'audio-capture' : '‚ùå KEIN MIKROFON GEFUNDEN',
                    'network'       : '‚ö†Ô∏è NETZWERKFEHLER ‚Äì kurze Pause',
                    'aborted'       : '‚èπÔ∏è ABGEBROCHEN',
                };
                setStatus(errMsgs[event.error] || `‚ùå FEHLER: ${event.error}`, isFatal ? 'err' : 'warn');

                if (isFatal) {
                    document.getElementById('btnMic').classList.remove('active');
                    const box = document.getElementById('recordingBox');
                    box.contentEditable = "true";
                    document.getElementById('editHint').style.display = "block";
                }
                // no-speech / network / aborted: canRestart bleibt true
                // ‚Üí onend startet automatisch neu (gewolltes Verhalten)
            };

            // ‚îÄ‚îÄ‚îÄ onend: NUR neu starten wenn canRestart erlaubt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Kleines Delay (300ms) als zus√§tzliche Absicherung gegen
            // Rapid-Fire-Restarts auf langsamen Mobile-Ger√§ten
            recognition.onend = () => {
                if (canRestart) {
                    setTimeout(() => {
                        if (canRestart) { // nochmal pr√ºfen ‚Äì k√∂nnte sich ge√§ndert haben
                            try { recognition.start(); }
                            catch(e) { /* bereits aktiv */ }
                        }
                    }, 300);
                }
            };

            // ‚îÄ‚îÄ‚îÄ onstart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            recognition.onstart = () => {
                setStatus('üî¥  AUFNAHME L√ÑUFT ...', 'rec');
            };

            // ‚îÄ‚îÄ‚îÄ TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            window.toggleSpeech = function() {
                if (!db.active) return alert("W√§hle erst einen Klienten!");

                const btn = document.getElementById('btnMic');
                const box = document.getElementById('recordingBox');

                if (!isRecording) {
                    // ‚îÄ‚îÄ STARTEN ‚îÄ‚îÄ
                    finalText   = "";
                    isRecording = true;
                    canRestart  = true;   // Auto-Restart jetzt erlaubt

                    box.innerHTML = "";
                    box.style.display = "block";
                    box.contentEditable = "false";
                    document.getElementById('editHint').style.display = "none";
                    document.getElementById('wordCount').textContent = "";
                    btn.classList.add('active');
                    setStatus('üî¥  AUFNAHME L√ÑUFT ...', 'rec');

                    try { recognition.start(); }
                    catch(e) { /* bereits aktiv */ }

                } else {
                    // ‚îÄ‚îÄ STOPPEN ‚îÄ‚îÄ
                    canRestart  = false;  // Auto-Restart ZUERST sperren
                    isRecording = false;
                    recognition.stop();

                    btn.classList.remove('active');
                    setStatus('‚úÖ  BEREIT', 'ok');

                    box.contentEditable = "true";
                    box.focus();
                    document.getElementById('editHint').style.display = "block";

                    const rawText = box.innerText.trim();
                    if (rawText.length > 2) openModal('details');
                }
            };
        }

        // ‚îÄ‚îÄ‚îÄ FINALES SPEICHERN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function finalSave() {
            const box = document.getElementById('recordingBox');
            const rawText = box.innerText.trim();
            if (!rawText) return alert("Kein Text vorhanden.");

            const entry = {
                ts:  new Date().toLocaleString('de-DE', {
                         day:'2-digit', month:'2-digit', year:'numeric',
                         hour:'2-digit', minute:'2-digit'
                     }),
                art: document.getElementById('selArt').value,
                dur: document.getElementById('selDauer').value,
                txt: polieren(rawText)
            };

            if (!db.clients[db.active]) db.clients[db.active] = [];
            db.clients[db.active].unshift(entry);
            saveDB();
            closeModals();

            box.style.display = "none";
            box.innerHTML = "";
            document.getElementById('editHint').style.display = "none";
            document.getElementById('wordCount').textContent = "";
            setStatus('‚úÖ  GESPEICHERT', 'ok');
            render();
        }

        // ‚îÄ‚îÄ‚îÄ TEXT-POLISH (erweitert) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function polieren(t) {
            t = t
                .replace(/\s+punkt\b/gi,          ".")
                .replace(/\s+komma\b/gi,           ",")
                .replace(/\s+fragezeichen\b/gi,    "?")
                .replace(/\s+ausrufezeichen\b/gi,  "!")
                .replace(/\s+doppelpunkt\b/gi,     ":")
                .replace(/\s+semikolon\b/gi,       ";")
                .replace(/\s+bindestrich\b/gi,     "-")
                .replace(/\s+neue\s+zeile\b/gi,    "\n")
                .replace(/\s+neuer\s+absatz\b/gi,  "\n\n")
                .replace(/\s+in\s+anf√ºhrung\b/gi,  " \"")
                .replace(/\s+anf√ºhrung\s+zu\b/gi,  "\"")
                .trim();

            // Satzanf√§nge nach Punkt/Zeilenumbruch gro√üschreiben
            t = t.replace(/(^|[.!?\n]\s*)([a-z√§√∂√º])/g,
                          (_, pre, ch) => pre + ch.toUpperCase());

            return t.charAt(0).toUpperCase() + t.slice(
